# WebDAV 同步功能部署检查清单

## 代码审查

- [ ] 所有文件都已格式化
- [ ] 没有 TypeScript 错误
- [ ] 没有 ESLint 警告
- [ ] 内存泄漏已修复
- [ ] 错误处理完善

**验证命令：**
```bash
npm run lint
npm run type-check
npm run build
```

## 配置检查

- [ ] `.env` 中的 WebDAV 配置已更新
- [ ] `WEBDAV_URL` 指向正确的服务器
- [ ] `WEBDAV_USERNAME` 和 `WEBDAV_PASSWORD` 正确
- [ ] `WEBDAV_EBOOK_PATH` 指向 `/anx/data/file`
- [ ] 所有必需的环境变量都已设置

**验证步骤：**
```bash
# 检查 .env 文件
cat .env | grep WEBDAV
```

## 数据库检查

- [ ] Prisma 迁移已完成
- [ ] Book 表结构正确
- [ ] 没有数据丢失
- [ ] 旧的 fileUrl 字段已处理

**验证命令：**
```bash
npx prisma migrate status
npx prisma db push
```

## 功能测试

### 自动同步
- [ ] 进入 `/webread` 页面时自动同步
- [ ] 控制台显示同步日志
- [ ] 同步完成后显示书架
- [ ] 没有错误信息

### 手动同步
- [ ] 配置面板可以打开
- [ ] "Test Connection" 按钮工作正常
- [ ] "Sync Books" 按钮工作正常
- [ ] 显示同步结果统计

### 书籍上传
- [ ] 可以选择 EPUB 文件
- [ ] 上传完成后书籍出现在列表
- [ ] 文件出现在 WebDAV 服务器
- [ ] 没有错误信息

### 书籍阅读
- [ ] 可以打开书籍
- [ ] 书籍正常显示
- [ ] 可以翻页
- [ ] 阅读进度保存正确

### 离线阅读
- [ ] 断开网络后仍可打开已缓存的书籍
- [ ] 可以正常翻页
- [ ] 没有网络错误

### 书籍删除
- [ ] 可以删除书籍
- [ ] 书籍从列表中消失
- [ ] 文件从 WebDAV 中删除
- [ ] 本地缓存被清除

## 性能测试

- [ ] 首次同步时间 < 30 秒
- [ ] 已缓存书籍加载时间 < 2 秒
- [ ] UI 不会卡顿
- [ ] 没有内存泄漏

**测试方法：**
1. 打开浏览器开发者工具
2. 进入 Performance 标签
3. 记录各项操作的时间

## 浏览器兼容性

- [ ] Chrome/Edge 最新版本
- [ ] Firefox 最新版本
- [ ] Safari 最新版本
- [ ] 移动浏览器（iOS Safari、Chrome Mobile）

**测试工具：**
- BrowserStack
- Sauce Labs
- 本地测试

## 安全检查

- [ ] WebDAV 密码不在代码中硬编码
- [ ] 敏感信息存储在 `.env` 中
- [ ] 没有 XSS 漏洞
- [ ] 没有 CSRF 漏洞
- [ ] 用户认证正确

**验证步骤：**
```bash
# 检查是否有硬编码的密码
grep -r "password" app/ lib/ --include="*.ts" --include="*.tsx"
```

## 文档检查

- [ ] `QUICK_START_SYNC.md` 已创建
- [ ] `SYNC_GUIDE.md` 已创建
- [ ] `SYNC_TESTING.md` 已创建
- [ ] `FINAL_REFACTOR_SUMMARY.md` 已创建
- [ ] 所有文档都是最新的

## 日志和监控

- [ ] 所有关键操作都有日志
- [ ] 错误信息清晰明了
- [ ] 可以追踪同步过程
- [ ] 可以调试问题

**验证步骤：**
1. 打开浏览器控制台
2. 执行各项操作
3. 检查日志输出

## 备份和恢复

- [ ] WebDAV 服务器有备份
- [ ] 数据库有备份
- [ ] 备份策略已制定
- [ ] 恢复流程已测试

## 部署前最后检查

### 代码
```bash
# 运行完整的测试套件
npm run test

# 构建生产版本
npm run build

# 检查构建输出
ls -la .next/
```

### 配置
```bash
# 验证环境变量
echo "WebDAV URL: $WEBDAV_URL"
echo "WebDAV Path: $WEBDAV_EBOOK_PATH"
```

### 数据库
```bash
# 验证数据库连接
npx prisma db execute --stdin < /dev/null

# 检查表结构
npx prisma db execute --stdin << 'EOF'
SELECT * FROM "Book" LIMIT 1;
EOF
```

## 部署步骤

1. **准备阶段**
   - [ ] 创建部署分支
   - [ ] 运行所有测试
   - [ ] 代码审查通过
   - [ ] 文档更新完成

2. **部署阶段**
   - [ ] 备份数据库
   - [ ] 备份 WebDAV 数据
   - [ ] 部署代码到测试环境
   - [ ] 运行烟雾测试
   - [ ] 部署代码到生产环境

3. **验证阶段**
   - [ ] 检查应用是否正常运行
   - [ ] 检查日志是否有错误
   - [ ] 测试关键功能
   - [ ] 监控性能指标

4. **回滚计划**
   - [ ] 如果出现问题，立即回滚
   - [ ] 恢复数据库备份
   - [ ] 恢复 WebDAV 备份
   - [ ] 通知用户

## 部署后监控

### 第一天
- [ ] 每小时检查一次日志
- [ ] 监控错误率
- [ ] 监控性能指标
- [ ] 收集用户反馈

### 第一周
- [ ] 每天检查一次日志
- [ ] 监控同步成功率
- [ ] 监控用户活跃度
- [ ] 收集性能数据

### 持续监控
- [ ] 每周检查一次日志
- [ ] 监控长期趋势
- [ ] 优化性能
- [ ] 修复发现的问题

## 常见问题处理

### 问题：同步失败
**处理步骤：**
1. 检查 WebDAV 服务器状态
2. 检查网络连接
3. 查看错误日志
4. 重试同步

### 问题：书籍无法加载
**处理步骤：**
1. 检查文件是否存在
2. 检查文件是否损坏
3. 清空本地缓存
4. 重新同步

### 问题：性能下降
**处理步骤：**
1. 检查本地存储使用情况
2. 清空不需要的缓存
3. 优化 WebDAV 服务器
4. 增加服务器资源

## 成功标准

- ✅ 所有测试通过
- ✅ 没有关键错误
- ✅ 性能满足要求
- ✅ 用户反馈积极
- ✅ 系统稳定运行

## 签字确认

| 角色 | 名字 | 日期 | 签名 |
|------|------|------|------|
| 开发者 | | | |
| 测试者 | | | |
| 产品经理 | | | |
| 运维 | | | |

## 部署记录

**部署日期：** _______________
**部署人员：** _______________
**部署版本：** _______________
**部署环境：** _______________

**部署前状态：**
- 代码版本：
- 数据库版本：
- 用户数：

**部署后状态：**
- 代码版本：
- 数据库版本：
- 用户数：

**问题和解决方案：**
1. 
2. 
3. 

**备注：**

---

**部署完成时间：** _______________
**部署状态：** ✅ 成功 / ❌ 失败
