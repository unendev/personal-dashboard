# 存储逻辑对比：IndexedDB vs WebDAV

## 概述

WebRead 的存储机制已从 **IndexedDB** 迁移到 **WebDAV**。本文档详细对比两种存储方案的差异。

## 架构对比

### IndexedDB（旧方案）

```
┌─────────────────────────────────────┐
│         浏览器进程                   │
├─────────────────────────────────────┤
│  WebRead 应用                       │
│  ├─ EpubReader                      │
│  ├─ useReaderStore                  │
│  └─ ebookCache (IndexedDB)          │
├─────────────────────────────────────┤
│  IndexedDB 数据库                   │
│  ├─ 存储位置：浏览器本地            │
│  ├─ 容量：50MB-1GB                  │
│  └─ 数据：EPUB Blob                 │
└─────────────────────────────────────┘
```

**特点**：
- ✅ 本地存储，快速访问
- ✅ 无需网络连接
- ❌ 不支持跨设备同步
- ❌ 难以备份和管理
- ❌ 浏览器清除缓存时丢失数据

### WebDAV（新方案）

```
┌─────────────────────────────────────┐
│         浏览器进程                   │
├─────────────────────────────────────┤
│  WebRead 应用                       │
│  ├─ EpubReader                      │
│  ├─ useReaderStore                  │
│  └─ webdavCache (WebDAV)            │
├─────────────────────────────────────┤
│  HTTP/WebDAV 协议                   │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│      WebDAV 服务器                  │
├─────────────────────────────────────┤
│  存储位置：远程服务器                │
│  ├─ Nextcloud                       │
│  ├─ Synology NAS                    │
│  └─ 自建服务器                      │
├─────────────────────────────────────┤
│  文件系统                           │
│  └─ /ebooks/                        │
│     ├─ book-1.epub                  │
│     ├─ book-1.epub.meta             │
│     ├─ book-2.epub                  │
│     └─ book-2.epub.meta             │
└─────────────────────────────────────┘
```

**特点**：
- ✅ 支持跨设备同步
- ✅ 集中式存储和备份
- ✅ 灵活的部署选项
- ✅ 容量取决于服务器
- ❌ 需要网络连接
- ❌ 相对较慢（网络延迟）

## 功能对比

| 功能 | IndexedDB | WebDAV |
|------|-----------|--------|
| **本地存储** | ✅ | ❌ |
| **跨设备同步** | ❌ | ✅ |
| **离线访问** | ✅ | ⚠️ (需要缓存) |
| **存储容量** | 50MB-1GB | 取决于服务器 |
| **访问速度** | 快 (< 100ms) | 中等 (100-500ms) |
| **备份** | 困难 | 容易 |
| **数据持久性** | 低 (浏览器清除) | 高 (服务器存储) |
| **多用户支持** | ❌ | ✅ |
| **权限管理** | ❌ | ✅ |
| **版本控制** | ❌ | ⚠️ (取决于服务器) |

## 性能对比

### 操作延迟

| 操作 | IndexedDB | WebDAV | 差异 |
|------|-----------|--------|------|
| 缓存检查 | < 100ms | 100-500ms | +400ms |
| 文件读取 (1MB) | < 500ms | 500ms-2s | +1.5s |
| 文件写入 (1MB) | < 1s | 1-5s | +4s |
| 列出所有文件 | < 100ms | 200-1000ms | +900ms |

### 存储容量

| 方案 | 容量 | 说明 |
|------|------|------|
| IndexedDB | 50MB-1GB | 取决于浏览器和用户配置 |
| WebDAV | 无限制 | 取决于服务器存储空间 |

### 网络使用

| 操作 | IndexedDB | WebDAV |
|------|-----------|--------|
| 初始下载 | 0 (本地) | 完整文件大小 |
| 后续访问 | 0 (本地) | 完整文件大小 |
| 元数据同步 | 0 | 小 (< 1KB) |

## 数据流对比

### IndexedDB 数据流

```
用户打开书籍
    ↓
检查 IndexedDB 缓存
    ├─ 缓存命中 → 从 IndexedDB 读取 (< 100ms)
    └─ 缓存未命中 → 从 OSS 下载 → 存入 IndexedDB → 显示
    ↓
用户阅读
    ↓
位置变化 → 保存到数据库
    ↓
用户关闭浏览器
    ↓
IndexedDB 数据保留（直到浏览器清除缓存）
```

### WebDAV 数据流

```
用户打开书籍
    ↓
检查 WebDAV 缓存
    ├─ 缓存命中 → 从 WebDAV 读取 (100-500ms)
    └─ 缓存未命中 → 从 OSS 下载 → 上传到 WebDAV → 显示
    ↓
用户阅读
    ↓
位置变化 → 保存到数据库
    ↓
用户关闭浏览器
    ↓
WebDAV 数据保留（永久存储在服务器）
    ↓
其他设备可以访问相同的缓存
```

## 代码变更

### 导入变更

```typescript
// 之前
import * as ebookCache from '@/lib/ebook-cache';

// 现在
import * as webdavCache from '@/lib/webdav-cache';
```

### API 变更

```typescript
// 之前
if (ebookCache.isIndexedDBSupported()) {
  const blob = await ebookCache.getBook(bookId);
}

// 现在
if (webdavCache.isWebDAVSupported()) {
  const blob = await webdavCache.getBook(bookId);
}
```

### 配置变更

```env
# 之前（无需配置）
# IndexedDB 自动使用浏览器存储

# 现在
WEBDAV_URL="http://localhost:8080/webdav"
WEBDAV_USERNAME="admin"
WEBDAV_PASSWORD="admin"
WEBDAV_EBOOK_PATH="/ebooks"
```

## 使用场景对比

### 适合 IndexedDB 的场景

- ✅ 单设备使用
- ✅ 离线优先应用
- ✅ 不需要备份
- ✅ 小文件存储
- ✅ 快速访问优先

### 适合 WebDAV 的场景

- ✅ 多设备同步
- ✅ 团队协作
- ✅ 需要备份
- ✅ 大文件存储
- ✅ 集中管理优先

## 迁移影响

### 用户影响

| 方面 | 影响 | 说明 |
|------|------|------|
| 访问速度 | ⚠️ 略慢 | 网络延迟导致 |
| 离线访问 | ⚠️ 需要缓存 | 必须先缓存才能离线访问 |
| 跨设备 | ✅ 改进 | 可以在多设备间同步 |
| 存储空间 | ✅ 改进 | 不受浏览器限制 |
| 数据安全 | ✅ 改进 | 服务器备份 |

### 开发影响

| 方面 | 影响 | 说明 |
|------|------|------|
| 依赖 | ➕ 新增 | 需要安装 `webdav` 包 |
| 配置 | ➕ 新增 | 需要配置 WebDAV 服务器 |
| 部署 | ➕ 复杂 | 需要部署 WebDAV 服务器 |
| 测试 | ➕ 复杂 | 需要测试网络场景 |

## 性能优化建议

### 对于 WebDAV

1. **启用压缩**
   ```nginx
   gzip on;
   gzip_types application/epub+zip;
   ```

2. **启用缓存**
   ```typescript
   const response = await fetch(url, {
     headers: { 'Cache-Control': 'max-age=86400' }
   });
   ```

3. **使用 CDN**
   - 在 WebDAV 服务器前面部署 CDN
   - 加速全球访问

4. **优化网络**
   - 使用 HTTP/2
   - 启用 Keep-Alive
   - 减少往返次数

## 故障恢复

### IndexedDB 故障

- 数据丢失：浏览器清除缓存
- 恢复方式：重新下载文件

### WebDAV 故障

- 服务器宕机：无法访问缓存
- 恢复方式：重启服务器或切换到备用服务器
- 数据丢失：极少（服务器有备份）

## 总结

| 方面 | IndexedDB | WebDAV |
|------|-----------|--------|
| **适用场景** | 单设备、离线优先 | 多设备、协作优先 |
| **性能** | 快 | 中等 |
| **可靠性** | 低 | 高 |
| **可扩展性** | 低 | 高 |
| **管理复杂度** | 低 | 中等 |

**选择建议**：
- 如果需要跨设备同步和集中管理 → **WebDAV** ✅
- 如果只在单设备使用且需要快速访问 → **IndexedDB** ✅

---

**更新日期**：2025-12-16
**状态**：✅ 对比分析完成

