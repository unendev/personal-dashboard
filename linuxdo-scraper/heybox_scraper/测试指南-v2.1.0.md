# 小黑盒爬虫测试指南 v2.1.0

**版本**: v2.1.0-mcp-comment-fix  
**更新时间**: 2025-10-25 17:00  
**状态**: ✅ 已推送到GitHub

---

## 🎯 本次更新重点

### 1. 版本标识
- 启动日志显示版本号和更新时间
- 确认运行的是最新代码

### 2. 评论抓取修复
- 基于MCP Playwright调试验证
- 使用精确选择器：`.link-comment__comment-item`
- TreeWalker遍历提取评论内容

### 3. Token详情页激活
- ⭐ **关键改进**：在每个详情页重新注入Token
- 防止cookie作用域问题
- 确保认证在所有页面有效

### 4. 详细调试日志
- 显示帖子URL
- 检测评论区存在状态
- 显示评论项数量

---

## 📋 测试步骤

### 方法1：本地运行（推荐）

```bash
cd linuxdo-scraper
python heybox_scraper/heybox_playwright_scraper.py
```

**预期日志输出**：

```
================================================================================
🎮 小黑盒Playwright爬虫启动
📦 版本: v2.1.0-mcp-comment-fix          ← 确认这一行！
🕐 更新时间: 2025-10-25 17:00
================================================================================

配置信息：
  - 目标帖子数: 20
  - Token已配置: 是
  - AI分析: 是
  - 使用代理: 否

✓ 浏览器启动成功
✓ 页面创建成功
🌐 访问首页: https://www.xiaoheihe.cn/app/bbs/home
  ✓ 页面加载完成
  ✓ Token注入成功
  ✓ 页面刷新，Token已激活

[1/10] 处理: CS2皮肤市值暴跌
  💬 抓取评论: 167244970
     📍 URL: https://www.xiaoheihe.cn/app/bbs/link/167244970
     🔍 页面检测: 评论区=True, 评论项数=15    ← 关注这一行！
    ✓ 获取到 15 条评论                        ← 期望 > 0
```

---

## 🔍 问题诊断

### 情况1：评论区=True, 评论项数=15, 获取到 15 条评论
✅ **完美！** 一切正常运行

### 情况2：评论区=False, 评论项数=0, 获取到 0 条评论
⚠️ **问题：页面未加载评论区**

**可能原因**：
1. 帖子本身没有评论
2. 遇到滑块验证（Token未生效）
3. 页面加载时间不够

**解决方案**：
```python
# 在heybox_playwright_scraper.py中增加等待时间
await asyncio.sleep(3)  → await asyncio.sleep(5)
```

### 情况3：评论区=True, 评论项数=3, 获取到 0 条评论
⚠️ **问题：选择器匹配但提取失败**

**可能原因**：
- 评论内容过滤过于严格
- 文本节点提取逻辑问题

**调试方法**：
查看日志中的`console.log('评论提取失败:', e)`

### 情况4：版本号不对
❌ **严重问题：运行的是旧代码**

**解决方案**：
```bash
# 拉取最新代码
git pull origin master

# 确认文件更新
git log --oneline -5

# 应该看到：
# bcdcfa7 fix(heybox): Token in detail page + version log v2.1.0
```

---

## 📊 成功标准

### ✅ 完全成功
```
[1/10] 处理: 标题1
  💬 抓取评论: ID1
     🔍 页面检测: 评论区=True, 评论项数=15
    ✓ 获取到 15 条评论

[2/10] 处理: 标题2
  💬 抓取评论: ID2
     🔍 页面检测: 评论区=True, 评论项数=8
    ✓ 获取到 8 条评论
```

**标准**：
- 版本号正确：`v2.1.0-mcp-comment-fix`
- 至少70%的帖子获取到评论 (7/10)
- 评论数 > 0

### ⚠️ 部分成功
```
获取到评论：3/10
```

**可能原因**：
- 部分帖子真的没有评论
- 需要增加等待时间
- 部分页面结构不同

**下一步**：
- 检查具体是哪些帖子失败
- 单独测试这些帖子URL
- 调整等待时间或选择器

### ❌ 失败
```
所有帖子都是 0 条评论
```

**立即检查**：
1. 版本号是否为 `v2.1.0-mcp-comment-fix`
2. 日志中是否有报错
3. Token是否有效（尝试重新获取）

---

## 🚀 GitHub Actions测试

### 触发方式
1. 推送代码自动触发
2. 手动触发：GitHub → Actions → Heybox Scraper → Run workflow

### 查看结果
1. 进入Actions页面
2. 找到最新运行
3. 展开"Run Heybox Scraper"
4. 查看日志

**预期输出**：
```
📦 版本: v2.1.0-mcp-comment-fix
🕐 更新时间: 2025-10-25 17:00

[1/20] 处理: ...
  💬 抓取评论: ...
     🔍 页面检测: 评论区=True, 评论项数=X
    ✓ 获取到 X 条评论
```

---

## 🛠️ 故障排查

### 问题：Token过期
**症状**：遇到滑块验证，评论区=False

**解决**：
1. 访问 https://www.xiaoheihe.cn/app/bbs/home
2. 登录账号
3. F12 → Application → Cookies
4. 复制新的 `x_xhh_tokenid`
5. 更新 `.env` 文件
6. 重新运行

### 问题：Playwright浏览器未安装
**症状**：`playwright._impl._errors.Error: Executable doesn't exist`

**解决**：
```bash
python -m playwright install chromium
```

### 问题：依赖缺失
**症状**：`ModuleNotFoundError: No module named 'playwright_stealth'`

**解决**：
```bash
pip install playwright playwright-stealth
```

---

## 📈 下一步改进（如果仍失败）

### 1. 增加等待时间
```python
await asyncio.sleep(5)  # 从3秒改为5秒
```

### 2. 点击"查看更多评论"
```python
# 尝试点击展开按钮
try:
    more_btn = await page.query_selector('text="查看更多"')
    if more_btn:
        await more_btn.click()
        await asyncio.sleep(2)
except:
    pass
```

### 3. 截图调试
```python
await page.screenshot(path=f'debug_{post_id}.png')
```

### 4. 保存HTML
```python
html = await page.content()
with open(f'debug_{post_id}.html', 'w', encoding='utf-8') as f:
    f.write(html)
```

---

## ✅ 验收清单

- [ ] 版本号显示为 `v2.1.0-mcp-comment-fix`
- [ ] 更新时间显示为 `2025-10-25 17:00`
- [ ] 至少70%帖子有评论
- [ ] "页面检测"日志正常输出
- [ ] 没有Python报错
- [ ] AI分析包含评论内容
- [ ] 数据库保存成功

---

## 🎯 测试反馈

**如果测试失败，请提供**：
1. 完整日志（前20行 + 评论抓取部分）
2. 版本号截图
3. 失败的具体帖子ID
4. Token是否最新

**如果测试成功**：
🎉 恭喜！小黑盒爬虫完全正常运行！

---

**当前版本**: v2.1.0-mcp-comment-fix  
**测试状态**: 等待您的反馈 💬

