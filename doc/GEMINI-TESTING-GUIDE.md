# Gemini 集成测试指南

## 🚀 快速开始

### 1. 获取 Gemini API Key

**步骤**:
1. 访问 [Google AI Studio](https://aistudio.google.com/app/apikeys)
2. 点击 "Create API Key"
3. 选择或创建项目
4. 复制生成的 API Key

**注意**: 
- 免费层限制: 60 请求/分钟
- 无需信用卡即可使用
- 适合开发和测试

### 2. 配置环境变量

**添加到 `.env.local`**:
```env
GOOGLE_API_KEY=your_api_key_here
```

**验证配置**:
```bash
# 检查环境变量是否正确加载
echo $GOOGLE_API_KEY
```

### 3. 启动应用

```bash
npm run dev
```

---

## 🧪 测试场景

### 场景 1: 基础功能测试

**目标**: 验证 Gemini 模型可以正常响应

**步骤**:
```
1. 访问 http://localhost:3000/room/test-room?name=TestUser
2. 在 Header 中点击 "Gemini" 按钮
3. 在输入框输入: "你好，请介绍一下自己"
4. 点击 SEND 按钮
5. 观察 AI 响应
```

**预期结果**:
- ✓ AI 使用 Gemini 模型响应
- ✓ 响应内容为中文
- ✓ 响应流畅显示
- ✓ 没有错误提示

**验证方法**:
```bash
# 在浏览器开发者工具中查看
# Network → goc-chat 请求
# Response Headers 中应该有: X-Model-Used: gemini
```

### 场景 2: 工具调用测试

**目标**: 验证 Gemini 可以正确调用工具

**步骤**:
```
1. 切换到 Gemini 模型
2. 切换到 "Planner" 模式
3. 输入: "请更新笔记，添加一个新的任务：完成项目文档"
4. 观察 AI 是否使用了工具
```

**预期结果**:
- ✓ AI 使用 updateNote 或 addTodo 工具
- ✓ 工具调用显示在消息中
- ✓ 笔记或任务列表更新
- ✓ 没有错误

**验证方法**:
```bash
# 查看消息中的工具调用指示器
# 应该显示: "updateNote: Completed" 或 "addTodo: Completed"
```

### 场景 3: 模型切换测试

**目标**: 验证可以在 DeepSeek 和 Gemini 之间切换

**步骤**:
```
1. 使用 DeepSeek 发送消息: "你好"
2. 观察响应
3. 切换到 Gemini
4. 发送相同的消息: "你好"
5. 观察响应
6. 刷新页面
7. 验证模型选择是否保持为 Gemini
```

**预期结果**:
- ✓ 两个模型都能正常响应
- ✓ 响应内容可能不同（正常）
- ✓ 模型选择保存到 localStorage
- ✓ 刷新后模型选择保持

**验证方法**:
```bash
# 在浏览器控制台检查
localStorage.getItem('goc_ai_model')
# 应该返回: "gemini" 或 "deepseek"
```

### 场景 4: 流式响应测试

**目标**: 验证流式响应正常工作

**步骤**:
```
1. 使用 Gemini 模型
2. 输入一个需要长响应的问题
3. 观察响应是否逐字显示
4. 打开浏览器开发者工具 → Network
5. 查看 goc-chat 请求的响应流
```

**预期结果**:
- ✓ 响应逐字显示（不是一次性显示）
- ✓ 响应流畅，没有卡顿
- ✓ Network 中显示流式数据
- ✓ 完成后显示完整消息

**验证方法**:
```bash
# 在 Network 标签中查看
# goc-chat 请求应该显示 "streaming" 状态
# Response 应该是分块的数据
```

### 场景 5: 错误处理测试

**目标**: 验证错误处理和回退机制

**步骤**:
```
1. 临时删除 GOOGLE_API_KEY 环境变量
2. 重启应用
3. 尝试使用 Gemini 模型
4. 观察是否自动回退到 DeepSeek
```

**预期结果**:
- ✓ 自动回退到 DeepSeek
- ✓ 消息正常发送和响应
- ✓ 控制台有警告日志
- ✓ 用户体验不受影响

**验证方法**:
```bash
# 查看浏览器控制台
# 应该看到警告: "GOOGLE_API_KEY not configured, falling back to DeepSeek"
```

### 场景 6: 多用户同步测试

**目标**: 验证多用户环境下 Gemini 正常工作

**步骤**:
```
1. 打开两个浏览器窗口
2. 第一个窗口: 使用 DeepSeek
3. 第二个窗口: 使用 Gemini
4. 第一个窗口发送消息
5. 观察第二个窗口是否实时看到消息
6. 第二个窗口发送消息
7. 观察第一个窗口是否实时看到消息
```

**预期结果**:
- ✓ 两个窗口都能正常通信
- ✓ 消息实时同步
- ✓ 各自使用的模型独立工作
- ✓ 没有冲突或错误

---

## 📊 性能测试

### 响应时间测试

**测试方法**:
```bash
# 使用浏览器开发者工具 → Network
# 记录 goc-chat 请求的时间

# 或使用 curl 测试
curl -X POST http://localhost:3000/api/goc-chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "你好"}],
    "model": "gemini",
    "mode": "advisor",
    "players": [{"id": "user-1", "name": "Test"}]
  }'
```

**预期结果**:
- ✓ 首字响应: < 2 秒
- ✓ 完整响应: < 10 秒
- ✓ 流式处理: 流畅，无卡顿

### 并发测试

**测试方法**:
```bash
# 同时发送多个请求
for i in {1..5}; do
  curl -X POST http://localhost:3000/api/goc-chat \
    -H "Content-Type: application/json" \
    -d '{"messages": [{"role": "user", "content": "test"}], "model": "gemini"}' &
done
wait
```

**预期结果**:
- ✓ 所有请求都成功
- ✓ 没有超时
- ✓ 没有错误

---

## 🐛 故障排查

### 问题 1: Gemini 模型不响应

**症状**: 点击 Gemini 按钮后没有响应

**排查步骤**:
```bash
# 1. 检查 API Key 是否配置
echo $GOOGLE_API_KEY

# 2. 检查浏览器控制台是否有错误
# 打开开发者工具 → Console

# 3. 检查网络请求
# Network → goc-chat → 查看 Response
```

**解决方案**:
- 确保 GOOGLE_API_KEY 已配置
- 确保 API Key 有效
- 检查网络连接
- 查看服务器日志

### 问题 2: 自动回退到 DeepSeek

**症状**: 选择 Gemini 但实际使用 DeepSeek

**排查步骤**:
```bash
# 1. 检查 API Key 是否配置
echo $GOOGLE_API_KEY

# 2. 查看服务器日志
# 应该看到: "GOOGLE_API_KEY not configured"

# 3. 检查响应头
# Network → goc-chat → Response Headers
# 查看 X-Model-Used 字段
```

**解决方案**:
- 配置 GOOGLE_API_KEY
- 重启应用
- 清除浏览器缓存

### 问题 3: 工具调用失败

**症状**: 工具调用显示 "Executing..." 但不完成

**排查步骤**:
```bash
# 1. 检查浏览器控制台
# 查看是否有错误

# 2. 检查网络请求
# 查看响应是否完整

# 3. 查看服务器日志
# 查看是否有错误信息
```

**解决方案**:
- 检查工具定义是否正确
- 检查 Gemini 是否支持工具调用
- 尝试使用 DeepSeek 验证工具是否工作

### 问题 4: 流式响应卡顿

**症状**: 响应显示不流畅，有延迟

**排查步骤**:
```bash
# 1. 检查网络连接
# 打开 Network 标签，查看数据流

# 2. 检查浏览器性能
# 打开 Performance 标签，查看是否有性能问题

# 3. 检查服务器负载
# 查看服务器日志和资源使用
```

**解决方案**:
- 检查网络连接
- 关闭其他标签页
- 重启浏览器
- 检查服务器资源

---

## ✅ 测试检查清单

### 基础功能
- [ ] Gemini 模型可以正常响应
- [ ] 工具调用正常工作
- [ ] 流式响应流畅
- [ ] 错误处理正确

### 模型切换
- [ ] 可以在 DeepSeek 和 Gemini 之间切换
- [ ] 模型选择保存到 localStorage
- [ ] 刷新后模型选择保持
- [ ] 两个模型都能正常工作

### 多用户
- [ ] 多用户可以同时使用不同模型
- [ ] 消息实时同步
- [ ] 没有冲突或错误

### 性能
- [ ] 响应时间可接受
- [ ] 流式处理流畅
- [ ] 并发请求正常处理

### 错误处理
- [ ] API Key 缺失时自动回退
- [ ] 网络错误有处理
- [ ] 用户收到清晰的错误提示

---

## 📝 测试报告模板

```markdown
# Gemini 集成测试报告

## 测试日期
[日期]

## 测试环境
- 浏览器: [浏览器版本]
- Node 版本: [版本]
- 操作系统: [系统]

## 测试结果

### 基础功能
- [ ] 通过
- [ ] 失败
- 备注: [备注]

### 工具调用
- [ ] 通过
- [ ] 失败
- 备注: [备注]

### 模型切换
- [ ] 通过
- [ ] 失败
- 备注: [备注]

### 流式响应
- [ ] 通过
- [ ] 失败
- 备注: [备注]

### 错误处理
- [ ] 通过
- [ ] 失败
- 备注: [备注]

### 多用户
- [ ] 通过
- [ ] 失败
- 备注: [备注]

## 性能数据
- 平均响应时间: [时间]
- 首字响应时间: [时间]
- 并发处理能力: [数据]

## 总体评分
[评分]

## 建议
[建议]
```

---

## 🎯 总结

Gemini 集成已完成，可以通过以上测试场景进行验证。

**关键点**:
- ✅ 模型配置正确
- ✅ 工具调用兼容
- ✅ 流式处理支持
- ✅ 错误处理完善
- ✅ 自动回退机制

**建议**:
1. 完成所有测试场景
2. 验证性能指标
3. 测试错误处理
4. 部署前进行压力测试

